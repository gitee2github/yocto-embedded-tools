From 6a65c13ee13522f5d3c3a9f298ef35fe0162f9aa Mon Sep 17 00:00:00 2001
From: "beiling.xie" <xiekunxunn@huawei.com>
Date: Tue, 19 Jul 2022 12:01:01 +0800
Subject: [PATCH] support deviceauth for openeuler

Signed-off-by: beiling.xie <xiekunxun@huawei.com>
---
 deps_adapter/BUILD.gn                                 |  3 ++-
 deps_adapter/os_adapter/impl/src/linux/hc_dev_info.c  |  7 +++++--
 deps_adapter/os_adapter/interfaces/linux/hc_log.h     |  8 ++++----
 services/BUILD.gn                                     |  2 +-
 .../src/permission_adapter/permission_adapter.cpp     | 11 +++++++----
 5 files changed, 19 insertions(+), 12 deletions(-)

diff --git a/deps_adapter/BUILD.gn b/deps_adapter/BUILD.gn
index 28df2d9..9324baf 100644
--- a/deps_adapter/BUILD.gn
+++ b/deps_adapter/BUILD.gn
@@ -118,10 +118,11 @@ if (defined(ohos_lite)) {
     cflags = [ "-DHILOG_ENABLE" ]
     deps = [
       "//base/security/huks/interfaces/innerkits/huks_standard/main:libhukssdk",
-      "//base/startup/syspara_lite/interfaces/innerkits/native/syspara:syspara",
+#      "//base/startup/syspara_lite/interfaces/innerkits/native/syspara:syspara",
       "//third_party/cJSON:cjson_static",
       "//third_party/openssl:libcrypto_static",
       "//utils/native/base:utils",
+      "//third_party/bounds_checking_function:libsec_shared"
     ]
     external_deps = [ "hiviewdfx_hilog_native:libhilog" ]
   }
diff --git a/deps_adapter/os_adapter/impl/src/linux/hc_dev_info.c b/deps_adapter/os_adapter/impl/src/linux/hc_dev_info.c
index 800b7cf..c16f2f5 100644
--- a/deps_adapter/os_adapter/impl/src/linux/hc_dev_info.c
+++ b/deps_adapter/os_adapter/impl/src/linux/hc_dev_info.c
@@ -16,19 +16,22 @@
 #include "hc_dev_info.h"
 #include "hal_error.h"
 #include "hc_log.h"
-#include "parameter.h"
+//#include "parameter.h"
 #include "securec.h"
 
 #ifdef __cplusplus
 extern "C" {
 #endif
 
+#define DEFAULT_UDID_NAME "ABCDEF00ABCDEF00ABCDEF00ABCDEF00ABCDEF00ABCDEF00ABCDEF00ABCDEF00"
+
 int32_t HcGetUdid(uint8_t *udid, int32_t udidLen)
 {
     if (udid == NULL || udidLen < INPUT_UDID_LEN || udidLen > MAX_INPUT_UDID_LEN) {
         return HAL_ERR_INVALID_PARAM;
     }
-    int32_t res = GetDevUdid((char *)udid, udidLen);
+//    int32_t res = GetDevUdid((char *)udid, udidLen);
+    int32_t res = strncpy_s((char *)udid, udidLen, DEFAULT_UDID_NAME, strlen(DEFAULT_UDID_NAME));
     if (res != 0) {
         LOGE("[OS]: GetDevUdid fail! res: %d", res);
         return HAL_FAILED;
diff --git a/deps_adapter/os_adapter/interfaces/linux/hc_log.h b/deps_adapter/os_adapter/interfaces/linux/hc_log.h
index 7cfd649..f881d1e 100644
--- a/deps_adapter/os_adapter/interfaces/linux/hc_log.h
+++ b/deps_adapter/os_adapter/interfaces/linux/hc_log.h
@@ -44,10 +44,10 @@ void DevAuthLogPrint(DevAuthLogLevel level, const char *funName, const char *fmt
 #define LOGW(fmt, ...) (DevAuthLogPrint(DEV_AUTH_LOG_LEVEL_WARN, __FUNCTION__, fmt, ##__VA_ARGS__))
 #define LOGE(fmt, ...) (DevAuthLogPrint(DEV_AUTH_LOG_LEVEL_ERROR, __FUNCTION__, fmt, ##__VA_ARGS__))
 
-#define DEV_AUTH_LOG_DEBUG(buf) HiLogPrint(LOG_CORE, LOG_DEBUG, LOG_DOMAIN, "[DEVAUTH]", "%{public}s", buf)
-#define DEV_AUTH_LOG_INFO(buf) HiLogPrint(LOG_CORE, LOG_INFO, LOG_DOMAIN, "[DEVAUTH]", "%{public}s", buf)
-#define DEV_AUTH_LOG_WARN(buf) HiLogPrint(LOG_CORE, LOG_WARN, LOG_DOMAIN, "[DEVAUTH]", "%{public}s", buf)
-#define DEV_AUTH_LOG_ERROR(buf) HiLogPrint(LOG_CORE, LOG_ERROR, LOG_DOMAIN, "[DEVAUTH]", "%{public}s", buf)
+#define DEV_AUTH_LOG_DEBUG(buf) HiLogPrint(LOG_CORE, LOG_DEBUG, LOG_DOMAIN, "[DEVAUTH]", "%s", buf)
+#define DEV_AUTH_LOG_INFO(buf) HiLogPrint(LOG_CORE, LOG_INFO, LOG_DOMAIN, "[DEVAUTH]", "%s", buf)
+#define DEV_AUTH_LOG_WARN(buf) HiLogPrint(LOG_CORE, LOG_WARN, LOG_DOMAIN, "[DEVAUTH]", "%s", buf)
+#define DEV_AUTH_LOG_ERROR(buf) HiLogPrint(LOG_CORE, LOG_ERROR, LOG_DOMAIN, "[DEVAUTH]", "%s", buf)
 
 #else
 
diff --git a/services/BUILD.gn b/services/BUILD.gn
index bb15b89..b2cdb17 100644
--- a/services/BUILD.gn
+++ b/services/BUILD.gn
@@ -159,10 +159,10 @@ if (defined(ohos_lite)) {
       "${deps_adapter_path}:${hal_module_name}",
       "//third_party/cJSON:cjson_static",
       "//utils/native/base:utils",
+      "//foundation/communication/dsoftbus/sdk:softbus_client"
     ]
 
     external_deps = [
-      "dsoftbus_standard:softbus_client",
       "hiviewdfx_hilog_native:libhilog",
     ]
     if (support_jsapi) {
diff --git a/services/frameworks/src/permission_adapter/permission_adapter.cpp b/services/frameworks/src/permission_adapter/permission_adapter.cpp
index dcdb912..6f4f8a3 100644
--- a/services/frameworks/src/permission_adapter/permission_adapter.cpp
+++ b/services/frameworks/src/permission_adapter/permission_adapter.cpp
@@ -15,17 +15,18 @@
 
 #include "permission_adapter.h"
 
-#include "accesstoken_kit.h"
+//#include "accesstoken_kit.h"
 #include "ipc_skeleton.h"
 
 #include "device_auth_defines.h"
 #include "hc_log.h"
 
-using namespace OHOS;
-using namespace OHOS::Security::AccessToken;
+//using namespace OHOS;
+//using namespace OHOS::Security::AccessToken;
 
 int32_t CheckPermission(void)
 {
+#if 0
     AccessTokenID tokenId = IPCSkeleton::GetCallingTokenID();
     ATokenTypeEnum tokenType = AccessTokenKit::GetTokenType(tokenId);
     if (tokenType == TOKEN_NATIVE) {
@@ -45,4 +46,6 @@ int32_t CheckPermission(void)
         LOGE("Invalid token type: %d", tokenType);
         return HC_ERROR;
     }
-}
\ No newline at end of file
+#endif
+    return HC_SUCCESS;
+}
-- 
2.25.1

